<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Decks - Memo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <link rel="stylesheet" href="./my-decks.css"/>
</head>
<body>
    <!-- My Decks Page -->
    <div class="my-decks-page">
        <div class="header">
            <div class="menu-icon" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
            <div class="account-menu">
                <div class="account-icon"><i class="fas fa-user-circle"></i></div>
                <div class="account-dropdown" id="accountDropdown">
                    <div class="account-header">
                        <div class="account-avatar" id="accountAvatar">?</div>
                        <div class="account-info">
                            <div class="account-name" id="accountName">Guest</div>
                            <div class="account-email" id="accountEmail">Not logged in</div>
                        </div>
                    </div>
                    <div class="account-dropdown-menu">
                        <div class="account-dropdown-item" onclick="goToPage('settings.html')">
                            <i class="fas fa-cog"></i>
                            Settings
                        </div>
                        <div class="account-dropdown-item" id="logoutButton">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="content">
            <h1 class="page-title">My Decks</h1>
            
            <!-- Ready-to-use Decks Section -->
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-book"></i> Ready-to-use Decks
                </h2>
            </div>
            <div class="default-decks-grid" id="defaultDecksContainer">
                <!-- Default decks will be loaded here -->
                <div class="no-decks-message">
                    <p>Loading ready-to-use decks...</p>
                </div>
            </div>
            <br>
            <!-- User's Decks Section -->
            <h2 class="section-title">
                <i class="fas fa-layer-group"></i> My Created Decks
            </h2>
            <div class="decks-container" id="userDecksContainer">
                <!-- User decks will be loaded here dynamically -->
            </div>
            
            <div class="button-container">
                <button class="create-deck-button" onclick="goToPage('new-card.html')">
                    <i class="fas fa-plus"></i> Create New Deck
                </button>
                <button class="import-deck-button" onclick="showImportDialog()">
                    <i class="fas fa-file-import"></i> Import Deck
                </button>
                <button class="export-deck-button" onclick="showExportDialog()">
                    <i class="fas fa-file-export"></i> Export Deck
                </button>
            </div>
        </div>
    </div>
    <!-- Başarılı İşlem Bildirimi -->
    <div class="success-notification" id="successNotification">
        <div class="success-notification-content">
            <i class="fas fa-check-circle"></i>
            <span id="successMessage">Imported Succesfully!</span>
        </div>
    </div>
    <!-- Confirmation Dialog -->
    <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog-box">
            <div class="dialog-title">Delete Deck</div>
            <div class="dialog-message" id="dialogMessage">Are you sure you want to delete this deck?</div>
            <div class="dialog-buttons">
                <button class="dialog-button cancel" onclick="closeDialog()">Cancel</button>
                <button class="dialog-button confirm" id="confirmButton">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Import Dialog HTML -->
    <div class="dialog-overlay" id="importDialogOverlay">
        <div class="dialog-box import-dialog">
            <div class="dialog-title">Import Flashcards</div>
            <div class="dialog-message">
                <p>Upload a text file with your flashcards.</p>
                <p>We support tab-separated (#separator:tab) or line-separated flashcards.</p>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".txt">
                    <div class="file-format-selector">
                        <label>File format:</label>
                        <select id="fileFormatSelect">
                            <option value="auto">Auto-detect</option>
                            <option value="tab">Tab separated</option>
                            <option value="line">Line separated (front/back alternating)</option>
                            <option value="colon">Colon separated (front:back)</option>
                        </select>
                    </div>
                </div>
                <div id="importPreviewContainer" class="import-preview-container" style="display: none;">
                    <h4>Preview:</h4>
                    <div id="importPreview" class="import-preview"></div>
                    <div class="preview-stats">
                        <span id="previewCardCount">0</span> cards found
                    </div>
                </div>
            </div>
            <div class="dialog-buttons">
                <button class="dialog-button cancel" onclick="closeImportDialog()">Cancel</button>
                <button class="dialog-button" id="previewButton" onclick="previewImport()">Preview</button>
                <button class="dialog-button confirm" id="importButton" onclick="importFlashcards()" disabled>Import</button>
            </div>
        </div>
    </div>
    <!-- Export Dialog HTML -->
    <div class="dialog-overlay" id="exportDialogOverlay">
        <div class="dialog-box import-dialog">
            <div class="dialog-title">Export Flashcards</div>
            <div class="dialog-message">
                <p>Select a deck to export as text file.</p>
                <div class="export-deck-selector">
                    <label>Select deck:</label>
                    <select id="exportDeckSelect">
                        <option value="">-- Select a deck --</option>
                    </select>
                </div>
                <div class="file-format-selector">
                    <label>File format:</label>
                    <select id="exportFormatSelect">
                        <option value="tab">Tab separated (front\tback)</option>
                        <option value="line">Line separated (front and back on alternate lines)</option>
                    </select>
                </div>
                <div class="export-options">
                    <label>
                        <input type="checkbox" id="exportWithHeader" checked> 
                        Add format header (#separator:tab)
                    </label>
                </div>
            </div>
            <div class="dialog-buttons">
                <button class="dialog-button cancel" onclick="closeExportDialog()">Cancel</button>
                <button class="dialog-button confirm" id="exportButton" onclick="exportFlashcards()">Export</button>
            </div>
        </div>
    </div>
    <!-- Sidebar and Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <div class="sidebar-close" onclick="toggleSidebar()"><i class="fas fa-times"></i></div>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-item" onclick="goToPage('index.html')">
                <i class="fas fa-home"></i> Home
            </div>
            <div class="sidebar-item" onclick="goToPage('new-card.html')">
                <i class="fas fa-plus"></i> New Deck
            </div>
            <div class="sidebar-item" onclick="goToPage('my-decks.html')">
                <i class="fas fa-layer-group"></i> My Decks
            </div>
            <div class="sidebar-item" onclick="goToPage('about.html')">
                <i class="fas fa-info-circle"></i> About
            </div>
            <div class="sidebar-item" onclick="goToPage('settings.html')">
                <i class="fas fa-cog"></i> Settings
            </div>
            <div class="sidebar-item" onclick="goToPage('account.html')">
                <i class="fas fa-history"></i> Practice History
            </div>
        </div>
    </div>
    
    <script src="theme-loader.js"></script>
    <script src="default-decks.js"></script>
    <script src="auth-check.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Önceki yönlendirme bayraklarını temizle
            sessionStorage.removeItem('redirecting');
            sessionStorage.removeItem('redirectCount');
            
            // Kullanıcının localStorage'da var olup olmadığını kontrol et
            const currentUser = JSON.parse(localStorage.getItem('memo-current-user'));
            
            if (!currentUser || !currentUser.loggedIn) {
                // Kullanıcı yoksa, login sayfasına yönlendir
                console.log("No authenticated user, redirecting to login");
                sessionStorage.setItem('intendedDestination', window.location.href);
                window.location.href = 'login.html';
                return;
            }
            
            // Kullanıcı varsa, sayfa içeriğini başlat
            console.log("User authenticated:", currentUser.id);
            loadDecks();
        });
        // Global user variable
        let currentUser = null;
        
        // Load decks from Firestore and localStorage
        function loadDecks() {
            console.log("Starting to load decks...");
            
            checkAuthState().then(userData => {
                if (userData) {
                    currentUser = userData;
                    
                    console.log("User authenticated:", currentUser.id);
                    
                    // Kullanıcı hesap bilgilerini güncelle
                    updateAccountDisplay();
                    
                    // Varsayılan desteleri yükle
                    loadDefaultDecks();
                    
                    // Kullanıcı destelerini yükle
                    loadUserDecks();
                    
                    console.log("Decks loading process initiated successfully");
                } else {
                    // Redirect to login if not logged in
                    console.log("No authenticated user, redirecting to login");
                    sessionStorage.setItem('intendedDestination', window.location.href);
                    window.location.href = 'login.html';
                }
            }).catch(error => {
                console.error("Error checking authentication state:", error);
                
                // Fallback to localStorage
                const localUser = JSON.parse(localStorage.getItem('memo-current-user'));
                if (localUser && localUser.loggedIn) {
                    console.log("Using locally stored user data");
                    currentUser = localUser;
                    
                    // Kullanıcı hesap bilgilerini güncelle
                    document.getElementById('accountName').textContent = localUser.name || localUser.email.split('@')[0];
                    document.getElementById('accountEmail').textContent = localUser.email;
                    document.getElementById('accountAvatar').textContent = (localUser.name || localUser.email)[0].toUpperCase();
                    
                    // Desteleri yükle
                    loadDefaultDecks();
                    loadUserDecks();
                } else {
                    // Redirect to login
                    sessionStorage.setItem('intendedDestination', window.location.href);
                    window.location.href = 'login.html';
                }
            });
        }
        
        // Get best practice score for a deck (in percentage)
        function getBestScore(deckId) {
            return new Promise(resolve => {
                if (!currentUser) {
                    resolve(null);
                    return;
                }
                
                // Try to get from Firebase first
                db.collection('practice-history')
                    .where('userId', '==', currentUser.id)
                    .where('deckId', '==', deckId)
                    .get()
                    .then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            // Fall back to localStorage if no data found in Firebase
                            const practiceHistory = JSON.parse(localStorage.getItem(`memo-practice-history-${currentUser.id}`)) || [];
                            const deckSessions = practiceHistory.filter(session => session.deckId === deckId);
                            
                            if (deckSessions.length === 0) {
                                resolve(null); // No practice sessions found
                                return;
                            }
                            
                            // Calculate percentage scores for all sessions
                            const percentages = deckSessions.map(session => {
                                return Math.round((session.correctAnswers / session.totalCards) * 100);
                            });
                            
                            // Return the highest percentage
                            resolve(Math.max(...percentages));
                        } else {
                            // Calculate from Firebase data
                            const sessions = [];
                            querySnapshot.forEach(doc => {
                                sessions.push(doc.data());
                            });
                            
                            // Calculate percentage scores for all sessions
                            const percentages = sessions.map(session => {
                                return Math.round((session.correctAnswers / session.totalCards) * 100);
                            });
                            
                            // Return the highest percentage
                            resolve(Math.max(...percentages));
                        }
                    })
                    .catch(error => {
                        console.error("Error getting practice history:", error);
                        resolve(null);
                    });
            });
        }
        
        // Load default/ready-to-use decks
        function loadDefaultDecks() {
            const defaultDecksContainer = document.getElementById('defaultDecksContainer');
            
            // Yükleme mesajını göster
            defaultDecksContainer.innerHTML = '<div class="no-decks-message"><p>Loading ready-to-use decks...</p></div>';
            
            // Yükleme fonksiyonunu çağır
            try {
                // Global defaultDecks değişkenini kontrol et
                if (window.defaultDecks && Array.isArray(window.defaultDecks) && window.defaultDecks.length > 0) {
                    console.log("Loading default decks from global variable");
                    renderDefaultDecks(window.defaultDecks);
                    return;
                }
                
                // Firestore denemesi
                fetchDefaultDecks()
                    .then(defaultDecks => {
                        if (defaultDecks && defaultDecks.length > 0) {
                            renderDefaultDecks(defaultDecks);
                        } else {
                            // Firestore'dan deste bulunamadıysa, localStorage veya global değişkene dön
                            loadDefaultDecksFromLocalStorage();
                        }
                    })
                    .catch(error => {
                        console.error("Error loading default decks:", error);
                        loadDefaultDecksFromLocalStorage();
                    });
            } catch (error) {
                console.error("Error in loadDefaultDecks:", error);
                loadDefaultDecksFromLocalStorage();
            }
        }
        
        // LocalStorage'dan varsayılan desteleri yükle (yardımcı fonksiyon)
        function loadDefaultDecksFromLocalStorage() {
            console.log("Loading default decks from localStorage");
            
            // localStorage'dan tüm desteleri al
            const allDecks = JSON.parse(localStorage.getItem('memo-decks')) || [];
            
            // Varsayılan deste isimlerini içeren deste listesi
            const defaultDeckNames = [
                "İngilizce B2 Seviye - 100 Kelime",
                "İngilizce A2 Seviye - 100 Kelime",
                "Türk Tarihi Önemli Olaylar - 50 Madde",
                "İspanyolca A1 Seviye - 100 Kelime",
                "Almanca A1 Seviye - 100 Kelime",
                "Fransızca A1 Seviye - 100 Kelime",
                "İtalyanca A1 Seviye - 100 Kelime"
            ];
            
            // Varsayılan desteleri filtrele
            const defaultDecks = allDecks.filter(deck => 
                defaultDeckNames.includes(deck.name) || deck.userId === 'system-demo-decks'
            );
            
            if (defaultDecks.length > 0) {
                renderDefaultDecks(defaultDecks);
                return;
            }
            
            // Hala deste bulunamadıysa global defaultDecks değişkenini kullan
            if (window.defaultDecks && Array.isArray(window.defaultDecks)) {
                console.log("Using global defaultDecks as fallback");
                renderDefaultDecks(window.defaultDecks);
                return;
            }
            
            // Hiçbir deste bulunamadıysa, hata mesajı göster
            const defaultDecksContainer = document.getElementById('defaultDecksContainer');
            defaultDecksContainer.innerHTML = `
                <div class="no-decks-message">
                    <p>No ready-to-use decks were found. Try refreshing the page or reconnecting to the internet.</p>
                </div>
            `;
        }
        
        // Render default decks in a grid layout
        function renderDefaultDecks(defaultDecks) {
            const defaultDecksContainer = document.getElementById('defaultDecksContainer');
            
            // Clear container
            defaultDecksContainer.innerHTML = '';
            
            // Check if we have default decks
            if (!defaultDecks || defaultDecks.length === 0) {
                defaultDecksContainer.innerHTML = `
                    <div class="no-decks-message">
                        <p>No ready-to-use decks found.</p>
                    </div>
                `;
                return;
            }
            
            // Sort decks by name for consistent order
            defaultDecks.sort((a, b) => a.name.localeCompare(b.name));
            
            // İkon sınıflarını tanımla (dil veya konu kategorisine göre)
            const deckIcons = {
                'İngilizce': 'fas fa-language',
                'Almanca': 'fas fa-language',
                'İspanyolca': 'fas fa-language',
                'Fransızca': 'fas fa-language',
                'İtalyanca': 'fas fa-language',
                'Türk Tarihi': 'fas fa-monument'
            };
            
            // Create deck items
            defaultDecks.forEach(deck => {
                // Deste adına göre ikon belirle
                let iconClass = 'fas fa-book'; // varsayılan ikon
                
                // Deste adında dil veya konu var mı kontrol et
                for (const [key, value] of Object.entries(deckIcons)) {
                    if (deck.name.includes(key)) {
                        iconClass = value;
                        break;
                    }
                }
                
                // Kart sayısını kontrol et
                const cardCount = deck.cards && Array.isArray(deck.cards) ? deck.cards.length : 0;
                
                const deckElement = document.createElement('div');
                deckElement.className = 'default-deck-item';
                
                // Deste elemanını oluştur (başlangıçta best score olmadan)
                deckElement.innerHTML = `
                    <div class="default-deck-icon">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="default-deck-title">${deck.name}</div>
                    <div class="default-deck-stats">
                        <i class="fas fa-layer-group"></i> ${cardCount} cards
                    </div>
                    <button class="default-deck-play" onclick="playDeck('${deck.id}', '${encodeURIComponent(deck.name)}')">
                        <i class="fas fa-play"></i> Play
                    </button>
                `;
                
                // Elemanı container'a ekle
                defaultDecksContainer.appendChild(deckElement);
                
                // Asenkron olarak en iyi skoru getir
                getBestScore(deck.id).then(bestScore => {
                    if (bestScore !== null) {
                        // En iyi skor varsa, elemanı güncelle
                        const scoreElement = document.createElement('div');
                        scoreElement.className = 'default-deck-best-score';
                        scoreElement.textContent = `${bestScore}%`;
                        deckElement.appendChild(scoreElement);
                    }
                });
            });
        }
        function renderUserDecks(userDecks) {
            const userDecksContainer = document.getElementById('userDecksContainer');
            
            // Container'ı temizle
            userDecksContainer.innerHTML = '';
            
            if (!userDecks || userDecks.length === 0) {
                // Eğer deste yoksa, mesaj göster
                userDecksContainer.innerHTML = `
                    <div class="no-decks-message">
                        <p>You don't have any created decks yet.</p>
                        <p>Create your first deck to get started!</p>
                    </div>
                `;
                return;
            }
            
            // Desteleri oluşturulma tarihine göre sırala (en yeniler üstte)
            userDecks.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            
            // Her deste için eleman oluştur
            userDecks.forEach(deck => {
                const deckElement = document.createElement('div');
                deckElement.className = 'deck-item';
                
                // Kart sayısını kontrol et
                const cardCount = deck.cards && Array.isArray(deck.cards) ? deck.cards.length : 0;
                
                // Deste elemanını oluştur (başlangıçta best score olmadan)
                deckElement.innerHTML = `
                    <div class="deck-header">
                        <div class="deck-title">${deck.name}</div>
                        <div class="deck-stats">
                            <i class="fas fa-layer-group"></i> ${cardCount} cards
                        </div>
                    </div>
                    <div class="deck-content">
                        <div class="deck-actions">
                            <button class="deck-action-button action-edit" onclick="editDeck('${deck.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="deck-action-button action-delete" onclick="confirmDeleteDeck('${deck.id}', '${deck.name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            <button class="deck-action-button action-play" onclick="playDeck('${deck.id}')">
                                <i class="fas fa-play"></i> Play
                            </button>
                        </div>
                    </div>
                `;
                
                // Deste elemanını container'a ekle
                userDecksContainer.appendChild(deckElement);
                
                // Asenkron olarak en iyi skoru getir
                getBestScore(deck.id).then(bestScore => {
                    if (bestScore !== null) {
                        // En iyi skor varsa, deste içeriğini güncelle
                        const deckContent = deckElement.querySelector('.deck-content');
                        const bestScoreElement = document.createElement('div');
                        bestScoreElement.className = 'best-score';
                        bestScoreElement.textContent = `Best score: ${bestScore}%`;
                        deckContent.insertBefore(bestScoreElement, deckContent.firstChild);
                    }
                });
            });
        }
        
        // Load user-created decks
        function loadUserDecks() {
            if (!currentUser) {
                console.error("No current user found");
                return;
            }
            
            const userDecksContainer = document.getElementById('userDecksContainer');
            
            // Yükleme mesajını göster
            userDecksContainer.innerHTML = '<div class="no-decks-message"><p>Loading your decks...</p></div>';
            
            try {
                // Varsayılan deste isimlerini içeren liste
                const defaultDeckNames = [
                    "İngilizce B2 Seviye - 100 Kelime",
                    "İngilizce A2 Seviye - 100 Kelime",
                    "Türk Tarihi Önemli Olaylar - 50 Madde",
                    "İspanyolca A1 Seviye - 100 Kelime",
                    "Almanca A1 Seviye - 100 Kelime",
                    "Fransızca A1 Seviye - 100 Kelime",
                    "İtalyanca A1 Seviye - 100 Kelime"
                ];
                
                // Kullanıcı destelerini getir
                fetchUserDecks(currentUser.id)
                    .then(userDecks => {
                        // Varsayılan olmayan desteleri filtrele
                        const filteredDecks = userDecks.filter(deck => 
                            !defaultDeckNames.includes(deck.name) && deck.userId === currentUser.id
                        );
                        
                        // Desteleri render et
                        renderUserDecks(filteredDecks);
                    })
                    .catch(error => {
                        console.error("Error loading user decks:", error);
                        
                        // Fallback olarak localStorage'dan yükle
                        const allDecks = JSON.parse(localStorage.getItem('memo-decks')) || [];
                        const userDecks = allDecks.filter(deck => 
                            !defaultDeckNames.includes(deck.name) && deck.userId === currentUser.id
                        );
                        
                        renderUserDecks(userDecks);
                    });
            } catch (error) {
                console.error("Error in loadUserDecks:", error);
                userDecksContainer.innerHTML = `
                    <div class="no-decks-message">
                        <p>Error loading your decks. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Mevcut playDeck fonksiyonunu şöyle güncelleyin
        function playDeck(deckId, encodedDeckName = '') {
            console.log("Play Deck called with:", { deckId, encodedDeckName });
            
            // Birincil olarak Firestore'da aramayı dene
            // localStorage'dan desteler alınır
            const decks = JSON.parse(localStorage.getItem('memo-decks')) || [];
            
            // ID'ye göre deste aranır
            let deck = decks.find(d => d.id === deckId);
            
            if (deck) {
                // Eğer deste bulunursa, normal şekilde yönlendir
                console.log("Found deck by ID in localStorage:", deck);
                goToPage(`practice.html?deck=${encodeURIComponent(deckId)}`);
            } else if (encodedDeckName) {
                // ID bulunamadıysa ve bir deste adı sağlanmışsa
                const deckName = decodeURIComponent(encodedDeckName);
                console.log("Looking for deck by name:", deckName);
                
                // Bu bir varsayılan deste olabilir
                console.log("Using name parameter for default deck");
                goToPage(`practice.html?default_deck=${encodedDeckName}`);
            } else {
                // Normal deste ID'si ile yönlendir (geriye dönük uyumluluk için)
                console.log("No deck name provided, using ID directly");
                goToPage(`practice.html?deck=${encodeURIComponent(deckId)}`);
            }
        }
                
        // Edit a deck
        function editDeck(deckId) {
            // Redirect to edit page with deck ID
            goToPage(`new-card.html?deck=${deckId}`);
        }
        
        // Show confirmation dialog for deck deletion
        function confirmDeleteDeck(deckId, deckName) {
            const dialogOverlay = document.getElementById('dialogOverlay');
            const dialogMessage = document.getElementById('dialogMessage');
            const confirmButton = document.getElementById('confirmButton');
            
            dialogMessage.textContent = `Are you sure you want to delete "${deckName}"? This can't be undone.`;
            dialogOverlay.style.display = 'flex';
            
            // Set up confirm button action
            confirmButton.onclick = function() {
                deleteDeck(deckId);
                closeDialog();
            };
        }
        
        // Close confirmation dialog
        function closeDialog() {
            document.getElementById('dialogOverlay').style.display = 'none';
        }
        
        // Delete a deck
        function deleteDeck(deckId) {
            // Delete from Firestore
            db.collection('decks').doc(deckId).delete()
                .then(() => {
                    console.log("Deck deleted from Firestore");
                    
                    // Also delete from localStorage
                    let decks = JSON.parse(localStorage.getItem('memo-decks')) || [];
                    decks = decks.filter(deck => deck.id !== deckId);
                    localStorage.setItem('memo-decks', JSON.stringify(decks));
                    
                    // Reload decks list
                    loadUserDecks();
                })
                .catch(error => {
                    console.error("Error deleting deck from Firestore:", error);
                    
                    // Fallback to localStorage only
                    let decks = JSON.parse(localStorage.getItem('memo-decks')) || [];
                    decks = decks.filter(deck => deck.id !== deckId);
                    localStorage.setItem('memo-decks', JSON.stringify(decks));
                    
                    // Reload decks list
                    loadUserDecks();
                });
        }
        
        // Function to toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                overlay.style.display = 'block';
                // Add small delay for smooth transition
                setTimeout(() => {
                    overlay.style.opacity = '1';
                }, 10);
            } else {
                overlay.style.opacity = '0';
                // Add small delay for smooth transition
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        }
        
        // Function to navigate to another page
        function goToPage(url) {
            window.location.href = url;
        }
        
        // Load decks when page loads
        window.onload = function() {
            loadDecks();
        };
        
        // Update account display
        function updateAccountDisplay() {
            checkAuthState().then(userData => {
                if (userData) {
                    document.getElementById('accountName').textContent = userData.displayName || userData.email.split('@')[0];
                    document.getElementById('accountEmail').textContent = userData.email;
                    document.getElementById('accountAvatar').textContent = (userData.displayName || userData.email)[0].toUpperCase();
                } else {
                    document.getElementById('accountName').textContent = 'Guest';
                    document.getElementById('accountEmail').textContent = 'Not logged in';
                    document.getElementById('accountAvatar').textContent = '?';
                }
            });
        }
        
        // Toggle account dropdown
        function toggleAccountDropdown() {
            const dropdown = document.getElementById('accountDropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const accountMenu = document.querySelector('.account-menu');
            const dropdown = document.getElementById('accountDropdown');
            
            if (accountMenu && dropdown && !accountMenu.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // Logout function
        function handleLogout() {
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().signOut()
                    .then(() => {
                        console.log('User signed out from Firebase');
                        localStorage.removeItem('memo-current-user');
                        sessionStorage.removeItem('memo-current-user');
                        window.location.href = 'index.html';
                    })
                    .catch((error) => {
                        console.error('Error signing out:', error);
                        localStorage.removeItem('memo-current-user');
                        sessionStorage.removeItem('memo-current-user');
                        window.location.href = 'index.html';
                    });
            } else {
                localStorage.removeItem('memo-current-user');
                sessionStorage.removeItem('memo-current-user');
                window.location.href = 'index.html';
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="account-management.js"></script>
    <script>
        // Import Dialog için global değişkenler
    let parsedCards = [];
    let importedDeckName = '';
    let importFormat = 'auto';

    function showImportDialog() {
        const importDialogOverlay = document.getElementById('importDialogOverlay');
        if (importDialogOverlay) {
            importDialogOverlay.style.display = 'flex';
            
            // Reset form
            document.getElementById('fileInput').value = '';
            document.getElementById('fileFormatSelect').value = 'auto';
            document.getElementById('importPreviewContainer').style.display = 'none';
            document.getElementById('importButton').disabled = true;
            parsedCards = [];
            importedDeckName = '';
            
            // Bildirimin görünürlüğünü sıfırla
            document.getElementById('successNotification').classList.remove('show');
        }
    }

    // Import Dialog'u kapat
    function closeImportDialog() {
        const importDialogOverlay = document.getElementById('importDialogOverlay');
        if (importDialogOverlay) {
            importDialogOverlay.style.display = 'none';
        }
    }

    // Import formatını değiştir
    function changeImportFormat() {
        importFormat = document.getElementById('fileFormatSelect').value;
        
        // Dosya seçiliyse yeniden önizleme yapalım
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length > 0) {
            previewImport();
        }
    }

    // Dosya önizlemesi
    function previewImport() {
        const fileInput = document.getElementById('fileInput');
        const formatSelect = document.getElementById('fileFormatSelect');
        const previewContainer = document.getElementById('importPreviewContainer');
        const previewElement = document.getElementById('importPreview');
        const cardCountElement = document.getElementById('previewCardCount');
        const importButton = document.getElementById('importButton');
        
        if (fileInput.files.length === 0) {
            alert('Please select a file first.');
            return;
        }
        
        const file = fileInput.files[0];
        importedDeckName = file.name.replace('.txt', '');
        importFormat = formatSelect.value;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            
            // Parse cards based on format
            parsedCards = parseFlashcards(content, importFormat);
            
            // Show preview
            if (parsedCards.length > 0) {
                previewContainer.style.display = 'block';
                previewElement.innerHTML = '';
                
                // Just show first 5 cards in preview
                const previewCards = parsedCards.slice(0, 5);
                previewCards.forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'preview-card';
                    cardElement.innerHTML = `
                        <div class="preview-card-front">${escapeHtml(card.front)}</div>
                        <div class="preview-card-back">${escapeHtml(card.back)}</div>
                    `;
                    previewElement.appendChild(cardElement);
                });
                
                if (parsedCards.length > 5) {
                    const moreElement = document.createElement('div');
                    moreElement.textContent = `...and ${parsedCards.length - 5} more cards`;
                    moreElement.style.textAlign = 'center';
                    moreElement.style.fontStyle = 'italic';
                    moreElement.style.marginTop = '10px';
                    previewElement.appendChild(moreElement);
                }
                
                cardCountElement.textContent = parsedCards.length;
                importButton.disabled = false;
            } else {
                previewContainer.style.display = 'block';
                previewElement.innerHTML = '<div style="color: red;">No valid flashcards found in the file. Please check the format and try again.</div>';
                cardCountElement.textContent = '0';
                importButton.disabled = true;
            }
        };
        
        reader.readAsText(file);
    }

    // Flashcard'ları parse et
    function parseFlashcards(content, format) {
        // HTML etiketlerini temizle
        let isHtml = false;
        if (content.includes('#html:true')) {
            isHtml = true;
        }
        
        // Dosya başlığında format belirtisi var mı kontrol et
        if (content.includes('#separator:tab')) {
            format = 'tab';
        }
        
        // Satırlara böl
        const lines = content.split('\n').map(line => line.trim()).filter(line => line && !line.startsWith('#'));
        
        const cards = [];
        
        // Format'a göre parse işlemi
        if (format === 'tab' || (format === 'auto' && content.includes('\t'))) {
            // Tab-separated format
            for (const line of lines) {
                if (line.includes('\t')) {
                    const [front, back] = line.split('\t').map(part => part.trim());
                    if (front && back) {
                        cards.push({
                            front: isHtml ? stripHtml(front) : front,
                            back: isHtml ? stripHtml(back) : back
                        });
                    }
                }
            }
        } else if (format === 'colon' || (format === 'auto' && lines.some(line => line.includes(':')))) {
            // Colon-separated format
            for (const line of lines) {
                if (line.includes(':')) {
                    const [front, back] = line.split(':').map(part => part.trim());
                    if (front && back) {
                        cards.push({
                            front: isHtml ? stripHtml(front) : front,
                            back: isHtml ? stripHtml(back) : back
                        });
                    }
                }
            }
        } else if (format === 'line' || format === 'auto') {
            // Line-separated format (front and back on alternate lines)
            for (let i = 0; i < lines.length - 1; i += 2) {
                const front = lines[i];
                const back = lines[i + 1];
                if (front && back) {
                    cards.push({
                        front: isHtml ? stripHtml(front) : front,
                        back: isHtml ? stripHtml(back) : back
                    });
                }
            }
        }
        
        return cards;
    }

    // HTML öğelerini temizler
    function stripHtml(html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        return doc.body.textContent || '';
    }

    // HTML özel karakterlerini encode eder (XSS koruması)
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Flashcard'ları import et
    function importFlashcards() {
        if (parsedCards.length === 0) {
            alert('No valid flashcards found to import.');
            return;
        }
        
        if (!currentUser) {
            alert('You need to be logged in to import flashcards.');
            return;
        }
        
        // Create a new deck
        const newDeck = {
            id: 'deck-' + Date.now() + '-' + Math.floor(Math.random() * 10000),
            userId: currentUser.id,
            name: importedDeckName || 'Imported Deck',
            description: `Imported from text file on ${new Date().toLocaleDateString()}`,
            createdAt: new Date().toISOString(),
            cards: parsedCards.map(card => ({
                id: 'card-' + Date.now() + '-' + Math.floor(Math.random() * 10000),
                front: card.front,
                back: card.back,
                createdAt: new Date().toISOString()
            }))
        };
        
        // saveDeck() fonksiyonunu kullanarak kaydet
        saveDeck(newDeck)
            .then(() => {
                console.log('Deck saved successfully');
                
                // Bildirim göster
                const notification = document.getElementById('successNotification');
                const message = document.getElementById('successMessage');
                message.textContent = `${parsedCards.length} flashcards imported successfully!`;
                notification.classList.add('show');
                
                // 3 saniye sonra bildirimi kapat
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
                
                // Dialog'u kapat
                closeImportDialog();
                
                // Desteleri yeniden yükle
                loadUserDecks();
            })
            .catch(error => {
                console.error('Error saving imported deck:', error);
                alert('Error importing flashcards. Please try again.');
            });
    }

    // Event listener'ları ekle
    document.addEventListener('DOMContentLoaded', function() {
        // Format seçimi değiştiğinde önizlemeyi güncelle
        const formatSelect = document.getElementById('fileFormatSelect');
        if (formatSelect) {
            formatSelect.addEventListener('change', changeImportFormat);
        }
    });
    
    // Export Dialog için değişkenler
    let selectedDeckToExport = null;

    // Export Dialog'u göster
    function showExportDialog() {
        const exportDialogOverlay = document.getElementById('exportDialogOverlay');
        const exportDeckSelect = document.getElementById('exportDeckSelect');
        
        if (exportDialogOverlay) {
            // Reset form
            exportDeckSelect.innerHTML = '<option value="">-- Select a deck --</option>';
            document.getElementById('exportFormatSelect').value = 'tab';
            document.getElementById('exportWithHeader').checked = true;
            
            // Mevcut desteler listesini yükle
            loadDecksForExport();
            
            // Dialog'u göster
            exportDialogOverlay.style.display = 'flex';
        }
    }

    // Export Dialog'u kapat
    function closeExportDialog() {
        const exportDialogOverlay = document.getElementById('exportDialogOverlay');
        if (exportDialogOverlay) {
            exportDialogOverlay.style.display = 'none';
        }
    }

    // Desteler listesini export için yükle
    function loadDecksForExport() {
        const exportDeckSelect = document.getElementById('exportDeckSelect');
        
        // Tüm desteler
        let allDecks = JSON.parse(localStorage.getItem('memo-decks')) || [];
        
        // Varsayılan desteler
        const defaultDeckNames = [
            "İngilizce B2 Seviye - 100 Kelime",
            "İngilizce A2 Seviye - 100 Kelime",
            "Türk Tarihi Önemli Olaylar - 50 Madde",
            "İspanyolca A1 Seviye - 100 Kelime",
            "Almanca A1 Seviye - 100 Kelime",
            "Fransızca A1 Seviye - 100 Kelime",
            "İtalyanca A1 Seviye - 100 Kelime"
        ];
        
        // Kullanıcı destelerini ve varsayılan desteleri ayır
        const userDecks = allDecks.filter(deck => 
            deck.userId === currentUser.id && !defaultDeckNames.includes(deck.name)
        );
        
        const defaultDecks = allDecks.filter(deck => 
            defaultDeckNames.includes(deck.name)
        );
        
        // Önce kullanıcı desteleri
        if (userDecks.length > 0) {
            const userGroup = document.createElement('optgroup');
            userGroup.label = 'My Decks';
            
            userDecks.forEach(deck => {
                const option = document.createElement('option');
                option.value = deck.id;
                option.textContent = `${deck.name} (${deck.cards.length} cards)`;
                userGroup.appendChild(option);
            });
            
            exportDeckSelect.appendChild(userGroup);
        }
        
        // Sonra varsayılan desteler
        if (defaultDecks.length > 0) {
            const defaultGroup = document.createElement('optgroup');
            defaultGroup.label = 'Ready-to-use Decks';
            
            defaultDecks.forEach(deck => {
                const option = document.createElement('option');
                option.value = deck.id;
                option.textContent = `${deck.name} (${deck.cards.length} cards)`;
                defaultGroup.appendChild(option);
            });
            
            exportDeckSelect.appendChild(defaultGroup);
        }
        
        // Seçim değiştiğinde event listener
        exportDeckSelect.addEventListener('change', function() {
            const selectedDeckId = this.value;
            selectedDeckToExport = allDecks.find(deck => deck.id === selectedDeckId);
        });
    }

    // Desteleri text dosyası olarak dışa aktar
    function exportFlashcards() {
        if (!selectedDeckToExport) {
            alert('Please select a deck to export.');
            return;
        }
        
        const format = document.getElementById('exportFormatSelect').value;
        const addHeader = document.getElementById('exportWithHeader').checked;
        
        // Deste içeriğini seçilen formata göre formatla
        let content = '';
        
        // Başlık ekle
        if (addHeader) {
            if (format === 'tab') {
                content += '#separator:tab\n';
            } else {
                content += '#separator:line\n';
            }
            content += '#html:false\n\n';
        }
        
        // Kartları formatla
        if (format === 'tab') {
            // Tab-separated format
            selectedDeckToExport.cards.forEach(card => {
                content += `${card.front}\t${card.back}\n`;
            });
        } else {
            // Line-separated format
            selectedDeckToExport.cards.forEach(card => {
                content += `${card.front}\n${card.back}\n`;
            });
        }
        
        // Dosyayı indir
        downloadTextFile(content, selectedDeckToExport.name + '.txt');
        
        // Kullanıcıya bildirim göster
        showSuccessNotification(`Deck "${selectedDeckToExport.name}" exported successfully!`);
        
        // Dialog'u kapat
        closeExportDialog();
    }

    // Text dosyasını indirme fonksiyonu
    function downloadTextFile(content, filename) {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        
        document.body.appendChild(a);
        a.click();
        
        // Temizlik
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }

    // Başarı bildirimi gösterme fonksiyonu
    function showSuccessNotification(message) {
        const notification = document.getElementById('successNotification');
        const successMessage = document.getElementById('successMessage');
        
        successMessage.textContent = message;
        notification.classList.add('show');
        
        // 3 saniye sonra bildirimi kapat
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    </script>
    
    <script src="firebase-decks.js"></script>
    
</body>
</html>